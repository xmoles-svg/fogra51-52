<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Comparador TVI · ECI vs FOGRA51</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Comparador TVI · ECI → FOGRA51</h1>
    <p>Introdueix les lectures de la tira ECI (20, 40, 60, 80, 100) i el canal.</p>
  </header>

  <main>
    <section class="panel">
      <label for="canal">Canal:</label>
      <select id="canal">
        <option value="C">Cian</option>
        <option value="M">Magenta</option>
        <option value="Y">Groc</option>
        <option value="K">Negre</option>
      </select>

      <label for="perc">Percentatges llegits (tira ECI):</label>
      <!-- només els 5 punts -->
      <textarea id="perc" rows="1">20,40,60,80,100</textarea>

      <label for="vals">Valors TVI mesurats (%):</label>
      <textarea id="vals" rows="2">16,30,45,58,100</textarea>

      <p class="nota">* Pots posar 3, 4 o 5 punts. El sistema completa 0-100 automàticament.</p>

      <button id="btn">Comparar</button>
    </section>

    <section class="panel">
      <h2>Corba TVI</h2>
      <div class="chart-box">
        <canvas id="tviChart"></canvas>
      </div>
    </section>

    <section class="panel">
      <h2>Diferència TVI (mesurat – estàndard)</h2>
      <div class="chart-box">
        <canvas id="diffChart"></canvas>
      </div>
      <div id="resultat" class="resultat"></div>
    </section>
  </main>

  <footer>© 2025 · xmoles-svg</footer>

  <script>
    // 11 punts que usa FOGRA
    const TARGET = [0,10,20,30,40,50,60,70,80,90,100];

    // FOGRA51 aproximat (pots ajustar-lo després)
    const FOGRA51 = {
      "C": [0,15,27,37,45,52,57,61,64,67,100],
      "M": [0,17,29,39,47,54,59,63,66,68,100],
      "Y": [0,13,25,35,43,49,54,58,61,63,100],
      "K": [0,18,30,39,47,54,59,63,66,68,100]
    };

    let tviChart = null;
    let diffChart = null;

    // completa 0..100 a partir de 20,40,60,80,100 (o els que hi hagi)
    function expandToTarget(userPerc, userVals) {
      // pas 1: parelles i ordena
      const pairs = userPerc.map((p,i)=>({p: Number(p), v: Number(userVals[i])}))
                            .filter(o => !Number.isNaN(o.p) && !Number.isNaN(o.v))
                            .sort((a,b)=>a.p-b.p);

      // assegura 0 i 100 al conjunt de referència per poder interpolar
      if (!pairs.find(o => o.p === 0)) {
        pairs.unshift({p:0, v:0});
      }
      if (!pairs.find(o => o.p === 100)) {
        const last = pairs[pairs.length-1];
        // si l’últim no és 100, assumim 100 → 100 (tinta plena)
        if (last.p !== 100) pairs.push({p:100, v:100});
      }

      // pas 2: per a cada punt 0..100 fem interpolació lineal
      const out = TARGET.map(t => {
        // si hi ha un punt exacte, l’agafem
        const exact = pairs.find(o => o.p === t);
        if (exact) return exact.v;

        // busquem el punt inferior i superior
        let lower = null, upper = null;
        for (let i=0; i<pairs.length-1; i++) {
          const a = pairs[i];
          const b = pairs[i+1];
          if (a.p < t && t < b.p) {
            lower = a; upper = b;
            break;
          }
        }
        if (!lower) return pairs[0].v;
        if (!upper) return pairs[pairs.length-1].v;

        // interpolació lineal
        const ratio = (t - lower.p) / (upper.p - lower.p);
        return lower.v + ratio * (upper.v - lower.v);
      });

      return out;
    }

    function buildCharts() {
      const canal = document.getElementById('canal').value;
      const perc = document.getElementById('perc').value.split(',').map(s=>s.trim()).filter(Boolean);
      const vals = document.getElementById('vals').value.split(',').map(s=>s.trim()).filter(Boolean);

      if (perc.length !== vals.length) {
        alert("Mateix número de percentatges i valors, si us plau.");
        return;
      }

      const mesurat11 = expandToTarget(perc, vals);   // 11 punts
      const estandard = FOGRA51[canal];
      const diff = mesurat11.map((v,i)=> +(v - estandard[i]).toFixed(2));

      // gràfica TVI
      const ctx1 = document.getElementById('tviChart').getContext('2d');
      if (tviChart) tviChart.destroy();
      tviChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: TARGET,
          datasets: [
            {
              label: 'Mesurat',
              data: mesurat11,
              borderColor: '#1864ab',
              backgroundColor: 'rgba(24,100,171,0.12)',
              pointRadius: 4,
              pointBackgroundColor: '#fff',
              pointBorderColor: '#1864ab',
              tension: 0.4      // fa la corba “com la teva”
            },
            {
              label: 'FOGRA51 ('+canal+')',
              data: estandard,
              borderColor: '#888',
              borderDash: [4,3],
              pointRadius: 2,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1.8,
          plugins: {
            legend: { position: 'bottom' }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Guany de punt (%)' }
            },
            x: {
              title: { display: true, text: 'Percentatge (%)' }
            }
          }
        }
      });

      // gràfica diferència
      const ctx2 = document.getElementById('diffChart').getContext('2d');
      if (diffChart) diffChart.destroy();
      diffChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: TARGET,
          datasets: [
            {
              label: 'ΔTVI',
              data: diff,
              borderColor: '#c92a2a',
              backgroundColor: 'rgba(201,42,42,0.12)',
              pointRadius: 4,
              pointBackgroundColor: '#fff',
              pointBorderColor: '#c92a2a',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1.6,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Diferència (%)' },
              suggestedMin: -6,
              suggestedMax: 6,
              grid: { color: 'rgba(0,0,0,0.05)' }
            },
            x: {
              title: { display: true, text: 'Percentatge (%)' }
            }
          }
        }
      });

      // tolerància
      const maxDiff = Math.max(...diff.map(d => Math.abs(d)));
      const resDiv = document.getElementById('resultat');
      if (maxDiff <= 3) {
        resDiv.textContent = `✅ Dins tolerància ISO (±3%) · Δmax = ${maxDiff.toFixed(1)}%`;
        resDiv.className = 'resultat ok';
      } else {
        resDiv.textContent = `⚠️ Fora de tolerància · Δmax = ${maxDiff.toFixed(1)}%`;
        resDiv.className = 'resultat ko';
      }
    }

    document.getElementById('btn').addEventListener('click', buildCharts);

    // primera vegada
    buildCharts();
  </script>
</body>
</html>