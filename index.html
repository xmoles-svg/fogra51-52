<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comparador TVI · ECI / FOGRA</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Comparació de guany de punt (TVI)</h1>
    <p>Tira ECI · FOGRA51 / FOGRA52</p>
  </header>

  <main>
    <section class="bloc">
      <p><strong>Exemple d'entrada:</strong></p>
      <pre>
Percentatges: 0,10,20,40,70,90,100
Valors mesurats: 0,14,28,46,63,67,100
      </pre>

      <div class="grid">
        <div>
          <label for="estandard">Estàndard</label>
          <select id="estandard">
            <option value="FOGRA51" selected>FOGRA51 (PSO coated v3)</option>
            <option value="FOGRA52">FOGRA52 (PSO uncoated v3)</option>
          </select>
        </div>
        <div>
          <label for="canal">Canal</label>
          <select id="canal">
            <option value="C">Cian</option>
            <option value="M">Magenta</option>
            <option value="Y">Groc</option>
            <option value="K">Negre</option>
          </select>
        </div>
      </div>

      <textarea id="lectures" rows="5">0,10,20,40,70,90,100
0,14,28,46,63,67,100</textarea>

      <button onclick="comparar()">Comparar</button>
      <p class="nota">* Pots usar qualsevol nombre de punts.</p>
    </section>

    <section class="bloc">
      <h2>Corba TVI</h2>
      <div class="canvas-wrapper">
        <canvas id="tviChart"></canvas>
      </div>
    </section>

    <section class="bloc">
      <h2>Diferència (mesurat − estàndard)</h2>
      <div class="canvas-wrapper-sm">
        <canvas id="diffChart"></canvas>
      </div>
      <div id="resultat" class="resultat"></div>
    </section>
  </main>

  <footer>© 2025 · eina TVI basada en tira ECI</footer>

  <script>
    const TVI = {
      FOGRA51: {
        C: { x: [0,10,20,30,40,50,60,70,80,90,100], y: [0,15,27,37,45,52,57,61,64,67,100] },
        M: { x: [0,10,20,30,40,50,60,70,80,90,100], y: [0,17,29,39,47,54,59,63,66,68,100] },
        Y: { x: [0,10,20,30,40,50,60,70,80,90,100], y: [0,13,25,35,43,49,54,58,61,63,100] },
        K: { x: [0,10,20,30,40,50,60,70,80,90,100], y: [0,18,30,39,47,54,59,63,66,68,100] }
      },
      FOGRA52: {
        C: { x: [0,10,20,30,40,50,60,70,80,90,100], y: [0,14,26,36,44,51,56,60,63,66,100] },
        M: { x: [0,10,20,30,40,50,60,70,80,90,100], y: [0,16,28,38,46,53,58,62,65,67,100] },
        Y: { x: [0,10,20,30,40,50,60,70,80,90,100], y: [0,12,24,34,42,48,53,57,60,62,100] },
        K: { x: [0,10,20,30,40,50,60,70,80,90,100], y: [0,17,29,38,46,53,58,62,65,67,100] }
      }
    };

    let tviChart = null;
    let diffChart = null;

    function comparar() {
      const estandard = document.getElementById('estandard').value;
      const canal = document.getElementById('canal').value;
      const text = document.getElementById('lectures').value.trim().split('\n');

      if (text.length < 2) {
        alert("Posa 2 línies: percentatges i mesurats.");
        return;
      }

      const percent = text[0].split(',').map(v => Number(v.trim()));
      const mesurat = text[1].split(',').map(v => Number(v.trim()));

      // referència interpolada als punts que has introduït
      const refData = TVI[estandard][canal];
      const ref = percent.map(p => interpola(refData.x, refData.y, p));

      const diff = mesurat.map((v, i) => v - ref[i]);
      const maxDiff = Math.max(...diff.map(d => Math.abs(d)));

      // gràfic principal
      const tviCtx = document.getElementById('tviChart').getContext('2d');
      if (tviChart) tviChart.destroy();
      tviChart = new Chart(tviCtx, {
        type: 'line',
        data: {
          labels: percent,
          datasets: [
            { label: 'Mesurat', data: mesurat, borderColor: '#007bff', tension: 0.4, fill: false },
            { label: estandard + ' (' + canal + ')', data: ref, borderColor: '#888', borderDash: [5,5], tension: 0.4, fill: false }
          ]
        },
        options: {
          scales: {
            y: { beginAtZero: true, suggestedMax: 100, title: { display: true, text: 'Guany de punt (%)' } }
          },
          plugins: { legend: { position: 'bottom' } }
        }
      });

      // gràfic de diferència
      const diffCtx = document.getElementById('diffChart').getContext('2d');
      if (diffChart) diffChart.destroy();
      diffChart = new Chart(diffCtx, {
        type: 'line',
        data: { labels: percent, datasets: [{ label: 'ΔTVI', data: diff, borderColor: 'red', tension: 0.3, fill: false }] },
        options: { scales: { y: { suggestedMin: -6, suggestedMax: 6, title: { display: true, text: 'Diferència (%)' } } }, plugins: { legend: { display: false } } }
      });

      const resultat = document.getElementById('resultat');
      if (maxDiff <= 3)
        resultat.innerHTML = "✅ Dins tolerància ISO (±3%) · Δmax = " + maxDiff.toFixed(1) + "%";
      else
        resultat.innerHTML = "⚠️ Fora de tolerància · Δmax = " + maxDiff.toFixed(1) + "%";
    }

    function interpola(x, y, xq) {
      if (xq <= x[0]) return y[0];
      if (xq >= x[x.length-1]) return y[y.length-1];
      for (let i=0; i<x.length-1; i++) {
        if (xq >= x[i] && xq <= x[i+1]) {
          const t = (xq - x[i]) / (x[i+1]-x[i]);
          return y[i] + t*(y[i+1]-y[i]);
        }
      }
    }

    window.addEventListener('load', comparar);
  </script>
</body>
</html>