<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comparador TVI · ECI 20–100</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* per si no et pilla el style.css */
    body { background:#eef1f4; margin:0; font-family:system-ui, -apple-system, Arial, sans-serif;}
    main { max-width: 1000px; margin: 30px auto 60px; }
    .bloc { background:#fff; margin-bottom:25px; padding:25px 28px; border-radius:14px; box-shadow:0 4px 18px rgba(0,0,0,.03);}
    button { background:#0d6efd; color:#fff; border:none; padding:11px 14px; border-radius:6px; cursor:pointer; width:100%; font-weight:600;}
    button:hover { background:#0b5ed7; }
    textarea { width:100%; min-height:90px; }
    .grid { display:flex; gap:12px; margin-bottom:12px; }
    .grid > div { flex:1; }
    .canvas-wrapper, .canvas-wrapper-sm { background:#fff; }
    .canvas-wrapper canvas, .canvas-wrapper-sm canvas { width:100% !important; max-height:360px; }
    .canvas-wrapper-sm canvas { max-height:240px; }
    header { text-align:center; padding:20px 12px 0; }
    footer { text-align:center; color:#777; padding-bottom:40px; }
    @media (max-width:720px){ .grid{flex-direction:column;} }
  </style>
</head>
<body>
  <header>
    <h1>Comparació de guany de punt (TVI)</h1>
    <p>Tira ECI curta · punts 20, 40, 60, 80, 100</p>
  </header>

  <main>
    <section class="bloc">
      <p><strong>Format d’entrada (2 línies):</strong></p>
      <pre>
20,40,60,80,100
27,45,57,64,100
      </pre>

      <div class="grid">
        <div>
          <label for="estandard">Estàndard</label>
          <select id="estandard">
            <option value="FOGRA51" selected>FOGRA51 (coated)</option>
            <option value="FOGRA52">FOGRA52 (uncoated)</option>
          </select>
        </div>
        <div>
          <label for="canal">Canal</label>
          <select id="canal">
            <option value="C">Cian</option>
            <option value="M">Magenta</option>
            <option value="Y">Groc</option>
            <option value="K">Negre</option>
          </select>
        </div>
      </div>

      <textarea id="lectures">20,40,60,80,100
27,45,57,64,100</textarea>
      <button onclick="comparar()">Comparar</button>
      <p class="nota">* Pots posar només 20,40,60,80,100. El 0% ja l'afegim nosaltres.</p>
    </section>

    <section class="bloc">
      <h2>Corba TVI (guany de punt)</h2>
      <div class="canvas-wrapper">
        <canvas id="tviChart"></canvas>
      </div>
    </section>

    <section class="bloc">
      <h2>Diferència TVI (mesurat – estàndard)</h2>
      <div class="canvas-wrapper-sm">
        <canvas id="diffChart"></canvas>
      </div>
      <div id="resultat" class="resultat"></div>
    </section>
  </main>

  <footer>© 2025 · xmoles-svg</footer>

  <script>
    // referència ECI curta (valors IMPRESOS) 20-40-60-80-100
    const TVI_REF = {
      FOGRA51: {
        C: [27,45,57,64,100],
        M: [29,47,59,66,100],
        Y: [25,43,54,61,100],
        K: [30,47,59,66,100]
      },
      FOGRA52: {
        C: [26,44,56,63,100],
        M: [28,46,58,65,100],
        Y: [24,42,53,60,100],
        K: [29,46,58,65,100]
      }
    };

    // nominal real que volem veure al gràfic
    const NOMINALS_BASE = [0,20,40,60,80,100];   // <- aquí ja hi ha el 0

    let tviChart = null;
    let diffChart = null;

    function comparar() {
      const estandard = document.getElementById('estandard').value;
      const canal = document.getElementById('canal').value;

      const linies = document.getElementById('lectures').value.trim().split('\n');
      if (linies.length < 2) {
        alert("Posa 2 línies: 1a = 20,40,60,80,100 · 2a = valors mesurats");
        return;
      }

      // l’usuari dona 5 valors -> els passem a 6 afegint el 0 al davant
      const percentUser = linies[0].split(',').map(v => Number(v.trim()));
      const mesuratUser = linies[1].split(',').map(v => Number(v.trim()));

      if (percentUser.length !== 5 || mesuratUser.length !== 5) {
        alert("Han de ser 5 valors (20,40,60,80,100). El 0% ja el poso jo.");
        return;
      }

      // fem arrays de 6 punts
      const percent = [0, ...percentUser];              // 0,20,40,60,80,100
      const mesurat = [0, ...mesuratUser];             // 0,27,45,...
      const refAbs5 = TVI_REF[estandard][canal];       // 5 valors
      const refAbs = [0, ...refAbs5];                  // 0,27,45,...

      // TVI = imprès - nominal
      const tviMesurat = mesurat.map((v, i) => v - NOMINALS_BASE[i]);
      const tviRef     = refAbs.map((v, i) => v - NOMINALS_BASE[i]);

      // diferències
      const diff = tviMesurat.map((v, i) => v - tviRef[i]);
      const maxDiff = Math.max(...diff.map(d => Math.abs(d)));

      // GRÀFIC TVI
      const ctx1 = document.getElementById('tviChart').getContext('2d');
      if (tviChart) tviChart.destroy();
      tviChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: NOMINALS_BASE, // 0..100
          datasets: [
            {
              label: 'TVI mesurat',
              data: tviMesurat,
              borderColor: '#0066ff',
              backgroundColor: 'rgba(0,102,255,0.07)',
              tension: 0.45,
              pointRadius: 4,
              pointHoverRadius: 6
            },
            {
              label: estandard + ' (' + canal + ')',
              data: tviRef,
              borderColor: '#888',
              borderDash: [5,5],
              tension: 0.45,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          aspectRatio: 2.1,
          scales: {
            y: {
              title: { display: true, text: 'Guany de punt (%)' },
              suggestedMin: 0,
              suggestedMax: 25
            },
            x: {
              title: { display: true, text: 'Trama nominal (%)' }
            }
          },
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // GRÀFIC DIFERÈNCIA
      const ctx2 = document.getElementById('diffChart').getContext('2d');
      if (diffChart) diffChart.destroy();
      diffChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: NOMINALS_BASE,
          datasets: [{
            label: 'ΔTVI',
            data: diff,
            borderColor: 'red',
            backgroundColor: 'rgba(255,0,0,0.1)',
            tension: 0.35,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              title: { display: true, text: 'Diferència (%)' },
              suggestedMin: -6,
              suggestedMax: 6
            }
          },
          plugins: { legend: { display: false } }
        }
      });

      // RESULTAT
      const r = document.getElementById('resultat');
      if (maxDiff <= 3) {
        r.innerHTML = "✅ Dins tolerància ISO (±3%) · Δmax = " + maxDiff.toFixed(1) + "%";
      } else {
        r.innerHTML = "⚠️ Fora de tolerància · Δmax = " + maxDiff.toFixed(1) + "%";
      }
    }

    window.addEventListener('load', comparar);
  </script>
</body>
</html>