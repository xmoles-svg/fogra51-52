<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comparador TVI · ECI 20–100</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Comparació de guany de punt (TVI)</h1>
    <p>Tira ECI curta · punts 20, 40, 60, 80, 100</p>
  </header>

  <main>
    <section class="bloc">
      <p><strong>Format d’entrada (2 línies):</strong></p>
      <pre>
20,40,60,80,100
27,45,57,64,100
      </pre>

      <div class="grid">
        <div>
          <label for="estandard">Estàndard</label>
          <select id="estandard">
            <option value="FOGRA51" selected>FOGRA51 (coated)</option>
            <option value="FOGRA52">FOGRA52 (uncoated)</option>
          </select>
        </div>
        <div>
          <label for="canal">Canal</label>
          <select id="canal">
            <option value="C">Cian</option>
            <option value="M">Magenta</option>
            <option value="Y">Groc</option>
            <option value="K">Negre</option>
          </select>
        </div>
      </div>

      <!-- aquí poses les teves lectures -->
      <textarea id="lectures" rows="4">20,40,60,80,100
27,45,57,64,100</textarea>

      <button onclick="comparar()">Comparar</button>
      <p class="nota">* Pots enganxar directament els valors de la màquina si són en %.</p>
    </section>

    <section class="bloc">
      <h2>Corba TVI (guany de punt)</h2>
      <div class="canvas-wrapper">
        <canvas id="tviChart"></canvas>
      </div>
    </section>

    <section class="bloc">
      <h2>Diferència TVI (mesurat − estàndard)</h2>
      <div class="canvas-wrapper-sm">
        <canvas id="diffChart"></canvas>
      </div>
      <div id="resultat" class="resultat"></div>
    </section>
  </main>

  <footer>© 2025 · xmoles-svg</footer>

  <script>
    // --- 1. Dades de referència en % de trama real IMPRESA (no TVI) ---
    // Les fem en 20-40-60-80-100 directament
    const TVI_REF = {
      FOGRA51: {
        C: [27,45,57,64,100],
        M: [29,47,59,66,100],
        Y: [25,43,54,61,100],
        K: [30,47,59,66,100]
      },
      FOGRA52: {
        C: [26,44,56,63,100],
        M: [28,46,58,65,100],
        Y: [24,42,53,60,100],
        K: [29,46,58,65,100]
      }
    };

    // Nominals de la tira ECI curta
    const NOMINALS = [20, 40, 60, 80, 100];

    let tviChart = null;
    let diffChart = null;

    function comparar() {
      const estandard = document.getElementById('estandard').value;
      const canal = document.getElementById('canal').value;

      // 1) llegim textarea
      const linies = document.getElementById('lectures').value.trim().split('\n');
      if (linies.length < 2) {
        alert("Posa 2 línies: 1a = percentatges (20,40,60,80,100), 2a = valors mesurats.");
        return;
      }

      const percent = linies[0].split(',').map(v => Number(v.trim()));
      const mesurat = linies[1].split(',').map(v => Number(v.trim()));

      // 2) validació
      if (percent.length !== 5 || mesurat.length !== 5) {
        alert("Han de ser EXACTAMENT 5 valors: 20,40,60,80,100.");
        return;
      }

      // 3) referència
      const refAbsolut = TVI_REF[estandard][canal]; // aquests també són % impresos

      // 4) convertim a TVI = imprès - nominal
      const tviMesurat = mesurat.map((v, i) => v - percent[i]);
      const tviRef = refAbsolut.map((v, i) => v - NOMINALS[i]);

      // 5) diferència de TVI
      const diff = tviMesurat.map((v, i) => v - tviRef[i]);
      const maxDiff = Math.max(...diff.map(d => Math.abs(d)));

      // --- 6. Gràfic principal (la corba que vols) ---
      const ctx1 = document.getElementById('tviChart').getContext('2d');
      if (tviChart) tviChart.destroy();
      tviChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: percent, // 20,40,60...
          datasets: [
            {
              label: 'TVI mesurat',
              data: tviMesurat,
              borderColor: '#0066ff',
              backgroundColor: 'rgba(0,102,255,0.12)',
              tension: 0.5,
              pointRadius: 4,
              pointHoverRadius: 6
            },
            {
              label: estandard + ' (' + canal + ')',
              data: tviRef,
              borderColor: '#888',
              borderDash: [5,5],
              tension: 0.5,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              title: { display: true, text: 'Guany de punt (%)' },
              suggestedMin: 0,
              suggestedMax: 30
            },
            x: {
              title: { display: true, text: 'Trama nominal (%)' }
            }
          },
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // --- 7. Gràfic de diferències ---
      const ctx2 = document.getElementById('diffChart').getContext('2d');
      if (diffChart) diffChart.destroy();
      diffChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: percent,
          datasets: [{
            label: 'ΔTVI',
            data: diff,
            borderColor: 'red',
            tension: 0.3,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              title: { display: true, text: 'Diferència (%)' },
              suggestedMin: -5,
              suggestedMax: 5
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });

      // --- 8. Resultat textual ---
      const r = document.getElementById('resultat');
      if (maxDiff <= 3) {
        r.innerHTML = "✅ Dins tolerància ISO (±3%) · Δmax = " + maxDiff.toFixed(1) + "%";
      } else {
        r.innerHTML = "⚠️ Fora de tolerància · Δmax = " + maxDiff.toFixed(1) + "%";
      }
    }

    // que dibuixi alguna cosa d’entrada
    window.addEventListener('load', comparar);
  </script>
</body>
</html>